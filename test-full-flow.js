// Test du flux complet inscription + onboarding
// Test avec un utilisateur ayant un profil complet
require('dotenv').config({ path: '.env.local' });

const testEmail = `test${Date.now()}@example.com`;
const testPassword = 'password123';

console.log('=== Test avec Profil Complet ===');

const cookies = new Map();

const fetchWithCookies = async (url, options = {}) => {
  options.credentials = 'include';
  
  const cookieString = Array.from(cookies.entries())
    .map(([name, value]) => `${name}=${value}`)
    .join('; ');
  
  if (cookieString) {
    options.headers = {
      ...options.headers,
      'Cookie': cookieString
    };
  }

  const response = await fetch(url, options);
  
  const setCookieHeader = response.headers.get('set-cookie');
  if (setCookieHeader) {
    const match = setCookieHeader.match(/auth-token=([^;]+)/);
    if (match) {
      cookies.set('auth-token', match[1]);
    }
  }
  
  return response;
};

async function testCompleteProfileUser() {
  try {
    console.log('üìß Email:', testEmail);
    console.log('üîê Password:', testPassword);
    console.log('');

    // 1. INSCRIPTION
    console.log('1Ô∏è‚É£ INSCRIPTION');
    const registerResponse = await fetchWithCookies('http://localhost:3000/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: testEmail, password: testPassword })
    });

    if (!registerResponse.ok) {
      const error = await registerResponse.json();
      console.log('‚ùå Register failed:', error);
      return;
    }

    const userData = await registerResponse.json();
    console.log('‚úÖ Registration successful');
    console.log('üìã Profile complete:', userData.profileComplete);
    console.log('');

    // 2. COMPL√âTER LE PROFIL
    console.log('2Ô∏è‚É£ COMPL√âTER LE PROFIL');
    const profileData = {
      first_name: 'John',
      last_name: 'Doe',
      country: 'France',
      languages: ['fran√ßais', 'anglais'],
      hobbies: 'voyage, photographie'
    };

    const updateResponse = await fetchWithCookies('http://localhost:3000/api/auth/me', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(profileData)
    });

    if (!updateResponse.ok) {
      const error = await updateResponse.json();
      console.log('‚ùå Profile update failed:', error);
      return;
    }

    const updatedUser = await updateResponse.json();
    console.log('‚úÖ Profile completed');
    console.log('üìã Profile complete now:', updatedUser.profileComplete);
    console.log('');

    // 3. D√âCONNEXION
    console.log('3Ô∏è‚É£ LOGOUT');
    await fetchWithCookies('http://localhost:3000/api/auth/logout', { method: 'POST' });
    cookies.clear();
    console.log('‚úÖ Logged out');
    console.log('');

    // 4. RECONNEXION avec profil complet
    console.log('4Ô∏è‚É£ RECONNEXION (profil complet)');
    const loginResponse = await fetchWithCookies('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: testEmail, password: testPassword })
    });

    if (!loginResponse.ok) {
      const error = await loginResponse.json();
      console.log('‚ùå Login failed:', error);
      return;
    }

    const loginData = await loginResponse.json();
    console.log('‚úÖ Login successful');
    console.log('üë§ User:', loginData.user.email);
    console.log('üìã Profile complete:', loginData.user.profileComplete);
    
    if (loginData.user.profileComplete) {
      console.log('üéâ SUCCESS! L\'utilisateur devrait √™tre redirig√© vers la page principale');
    } else {
      console.log('‚ùå PROBL√àME: Profil marqu√© comme incomplet malgr√© les donn√©es');
      console.log('üîç D√©tails du profil:');
      console.log('  - first_name:', loginData.user.first_name);
      console.log('  - last_name:', loginData.user.last_name);
      console.log('  - country:', loginData.user.country);
      console.log('  - languages:', loginData.user.languages);
    }

  } catch (error) {
    console.error('üí• Error:', error);
  }
}

testCompleteProfileUser();

async function testFullFlow() {
  try {
    console.log('üß™ Test du flux complet...')
    
    // 1. Inscription
    console.log('1Ô∏è‚É£ Inscription...')
    const registerResponse = await fetch('http://localhost:3000/api/auth/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email: testEmail,
        password: testPassword
      })
    })
    
    if (!registerResponse.ok) {
      console.log('‚ùå Erreur d\'inscription:', await registerResponse.text())
      return
    }
    
    const userData = await registerResponse.json()
    console.log('‚úÖ Inscription r√©ussie:', userData)
    
    // R√©cup√©rer le cookie d'authentification
    const authCookie = registerResponse.headers.get('set-cookie')
    console.log('üç™ Cookie d\'auth:', authCookie ? 'pr√©sent' : 'absent')
    
    // 2. V√©rifier l'√©tat utilisateur
    console.log('2Ô∏è‚É£ V√©rification de l\'utilisateur...')
    const meResponse = await fetch('http://localhost:3000/api/auth/me', {
      headers: {
        'Cookie': authCookie || ''
      }
    })
    
    if (meResponse.ok) {
      const userInfo = await meResponse.json()
      console.log('‚úÖ Utilisateur r√©cup√©r√©:', userInfo)
      
      // 3. Test de mise √† jour du profil
      console.log('3Ô∏è‚É£ Mise √† jour du profil...')
      const updateResponse = await fetch('http://localhost:3000/api/auth/me', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': authCookie || ''
        },
        body: JSON.stringify({
          first_name: 'Test',
          last_name: 'User',
          country: 'France',
          languages: ['Fran√ßais', 'Anglais'],
          hobbies: 'Test, D√©veloppement'
        })
      })
      
      if (updateResponse.ok) {
        const updatedUser = await updateResponse.json()
        console.log('‚úÖ Profil mis √† jour:', updatedUser)
      } else {
        console.log('‚ùå Erreur de mise √† jour:', await updateResponse.text())
      }
    } else {
      console.log('‚ùå Erreur de r√©cup√©ration utilisateur:', await meResponse.text())
    }
    
  } catch (error) {
    console.error('üí• Erreur:', error)
  }
}

testFullFlow()
