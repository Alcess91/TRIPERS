<!DOCTYPE html>
<html>
<head>
    <title>Auth Test</title>
</head>
<body>
    <h1>Browser Auth Test</h1>
    <p>Check the console for test results...</p>
    <script>
        console.log('üß™ Running Browser Auth Test...');

        // Test 1: Check if we can register and then immediately update profile
        async function testInBrowser() {
          const testEmail = 'browser-direct-' + Date.now() + '@example.com';
          const testPassword = 'testpassword123';
          
          try {
            // 1. Register
            console.log('1. Registering...');
            const registerResponse = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ email: testEmail, password: testPassword })
            });
            
            if (!registerResponse.ok) {
              throw new Error('Register failed: ' + registerResponse.status);
            }
            
            const userData = await registerResponse.json();
            console.log('‚úÖ Registered:', userData);
            
            // 2. Check auth immediately 
            console.log('2. Checking auth...');
            const authResponse = await fetch('/api/auth/me', {
              credentials: 'include'
            });
            
            if (!authResponse.ok) {
              throw new Error('Auth check failed: ' + authResponse.status);
            }
            
            const authData = await authResponse.json();
            console.log('‚úÖ Auth check:', authData);
            
            // 3. Update profile
            console.log('3. Updating profile...');
            const profileData = {
              first_name: 'Browser',
              last_name: 'Test',
              country: 'France',
              languages: ['fran√ßais', 'anglais'],
              hobbies: 'voyage, photographie'
            };
            
            const updateResponse = await fetch('/api/auth/me', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(profileData)
            });
            
            if (!updateResponse.ok) {
              const error = await updateResponse.text();
              throw new Error('Profile update failed: ' + updateResponse.status + ' - ' + error);
            }
            
            const updatedUser = await updateResponse.json();
            console.log('‚úÖ Profile updated:', updatedUser);
            console.log('üéâ SUCCESS! No "erreur lors de la mise √† jour du profil"');
            
            document.body.innerHTML += '<h2 style="color: green;">‚úÖ TEST PASSED!</h2>';
            
          } catch (error) {
            console.error('‚ùå Test failed:', error);
            document.body.innerHTML += '<h2 style="color: red;">‚ùå TEST FAILED: ' + error.message + '</h2>';
          }
        }

        testInBrowser();
    </script>
</body>
</html>
